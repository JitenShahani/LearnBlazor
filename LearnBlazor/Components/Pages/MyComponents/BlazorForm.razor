<PageTitle>Blazor Forms</PageTitle>

<_PageRenderModeSection />

<div class="col-12 offset-md-3 col-md-6 border rounded shadow-lg">
	<div class="text-center my-3">
		<h2 class="m-0">Product Form</h2>
		<hr />
	</div>

	<div class="m-3">
		<EditForm FormName="ProductForm"
			Model="Product"
			OnValidSubmit="HandleValidSubmit"
			OnInvalidSubmit="HandleInValidSubmit"
			Enhance
			method="post"
			class="border rounded p-3">
			<DataAnnotationsValidator />

			<div class="mb-3">
				<label for="productName" class="form-label">Product Name: </label>
				<InputText id="productName"
					class="form-control shadow-none"
					@ref="_productNameInput"
					@bind-Value="Product!.Name"
					autocomplete="off" />
				<ValidationMessage For="@(() => Product.Name)" />
			</div>

			<div class="mb-3">
				<label for="ProductPrice" class="form-label">Price: </label>
				<InputNumber id="ProductPrice"
					TValue="double"
					class="form-control shadow-none"
					@bind-Value="Product.Price"

					/>
				<ValidationMessage For="@(() => Product.Price)" />
			</div>

			<div class="mb-3">
				<label for="IsActive" class="form-label">Is Active: </label>
				<div class="form-check form-switch">
					<InputCheckbox DisplayName="Is Active" id="IsActive" class="form-check-input" @bind-Value="Product.IsActive" />
				</div>
			</div>

			<div class="mb-3">
				<label for="Category" class="form-label">Category: </label>
				<InputSelect id="Category" class="form-select" @bind-Value="Product.Category">
					<_Iterator Items="Enum.GetValues<Category>()" Context="category">
						<option value="@category">@(GetEnumDescription(category))</option>
					</_Iterator>
				</InputSelect>
			</div>

			<div class="mb-3">
				<label for="AvailableAfter" class="form-label">Available After: </label>
				<InputDate id="AvailableAfter"
					TValue="DateOnly?"
					DisplayName="Available After"
					class="form-control"
					@ref="_availableAfterInput"
					@bind-Value="Product.AvailableAfter"
					@onfocus="LoadCalendar" />
				<ValidationMessage For="@(() => Product.AvailableAfter)" />
			</div>

			<div class="mb-3">
				<Button Type="ButtonType.Submit"
						Color="ButtonColor.Primary"
						Outline="true"
						@ref="_submitButton">
					<LoadingTemplate>
						<Spinner Type="SpinnerType.Dots" Color="SpinnerColor.Primary" Class="me-1" /> Saving...
					</LoadingTemplate>
					<ChildContent>
						<Icon Name="IconName.Save2" /> Save Product
					</ChildContent>
				</Button>
			</div>
		</EditForm>
	</div>
</div>

<_Condition Evaluation="@(ProductList?.Count > 0)">
	<True>
		<div class="mt-5">
			<div class="grid">
				<_Iterator Items="ProductList" Context="product">
					<div class="card float-start me-2 mb-2">
						<div class="card-header">
							<h5 class="m-0 text-center">@product.Name</h5>
						</div>
						<div class="card-body">
							<ul class="list-group">
								<li class="list-group-item">Id: @product.Id</li>
								<li class="list-group-item">Price: @product.Price</li>
								<li class="list-group-item">Active: @product.IsActive</li>
								<li class="list-group-item">Category: @product.Category</li>
								<li class="list-group-item">Available After: @product.AvailableAfter</li>
							</ul>
						</div>
					</div>
				</_Iterator>
			</div>
		</div>
	</True>
</_Condition>

@page "/learnBlazor/blazorForms"
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime
@code {
	private InputText? _productNameInput;
	private InputDate<DateOnly?>? _availableAfterInput;
	private Button? _submitButton;

	[PersistentState]
	public Product? Product { get; set; }

	[PersistentState]
	public List<Product>? ProductList { get; set; }

	protected override void OnInitialized ()
	{
		if (Product is null)
		{
			Product = new ();
		}

		if (ProductList is null)
			ProductList = [];
	}

	protected override async Task OnAfterRenderAsync (bool firstRender)
	{
		if (firstRender)
			await FocusProductForm ();
	}

	private async Task LoadCalendar ()
	{
		await JSRuntime.InvokeVoidAsync ("showDatePicker", "AvailableAfter");
	}

	private async Task HandleInValidSubmit ()
		=> await FocusProductForm ();

	private async Task HandleValidSubmit ()
	{
		_submitButton?.ShowLoading ();

		await Task.Delay (1000);

		int nextId = ProductList!
			.Select (p => p.Id)
			.DefaultIfEmpty(0)
			.Max () + 1;

		Product?.Id = nextId;

		ProductList?.Add (Product!);

		_submitButton?.HideLoading ();

		Product = new ();

		// Ensure UI re-renders before trying to focus the input element
		await InvokeAsync (StateHasChanged);
		await FocusProductForm ();
	}

	private string GetEnumDescription (Enum value)
	{
		var enumValueAsString = value.ToString ();

		// var descriptionAttributeValue = value
		// 	.GetType ()
		// 	.GetField (enumValueAsString)?
		// 	.CustomAttributes
		// 		.FirstOrDefault (a => a.AttributeType == typeof (DescriptionAttribute))?
		// 		.ConstructorArguments
		// 			.FirstOrDefault ()
		// 			.Value?.ToString();

		var descriptionAttributeValue = value
			.GetType ()
			.GetField (enumValueAsString)?
			.GetCustomAttributes (false)
				.OfType<DescriptionAttribute> ()
				.FirstOrDefault ()?
				.Description;

		return descriptionAttributeValue ?? enumValueAsString;
	}

	private async Task FocusProductForm ()
		=> await _productNameInput!.Element!.Value.FocusAsync ();
}